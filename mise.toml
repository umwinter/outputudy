experimental_monorepo_root = true

[tools]
python = "3.12"
node = "22.16.0"
pnpm = "10.27.0"
uv = "latest"

[env]
# Required for monorepo features
MISE_EXPERIMENTAL = "1"

[tasks.up]
description = "Start all services (detached)"
run = "docker-compose up -d"

[tasks.down]
description = "Stop and remove containers"
run = "docker-compose down"

[tasks.build]
description = "Build/Rebuild services"
run = "docker-compose up -d --build"

[tasks.logs]
description = "Tail logs for all services"
run = "docker-compose logs -f"

[tasks.setup]
description = "Full project setup (Local)"
depends = ["setup-env", "setup-hooks", "setup-db"]
run = "echo 'âœ¨ Setup complete! Access: http://localhost:3000'"

[tasks."setup-env"]
description = "Create .env from .env.example if missing"
run = '''
if [ ! -f .env ]; then
    cp .env.example .env
    echo "âœ… .env created."
else
    echo "âœ… .env already exists."
fi
'''

[tasks."setup-hooks"]
description = "Install Git Hooks (pre-commit)"
run = '''
if command -v pre-commit >/dev/null 2>&1; then
    pre-commit install
    pre-commit install --hook-type pre-push
    echo "âœ… Git Hooks installed."
else
    echo "âš ï¸ pre-commit not found. Skipping."
fi
'''

[tasks."setup-db"]
description = "Initialize Database (Migrate & Seed)"
depends = ["up"]
run = '''
echo "ðŸ—„ï¸ Initializing Database..."
docker-compose run --rm migration
'''

[tasks."bootstrap-gcp"]
description = "GCP/CI Environment Setup (Aggregated)"
depends = [
    "bootstrap-gcp:api",
    "bootstrap-gcp:iam",
    "bootstrap-gcp:wif",
    "bootstrap-gcp:bucket",
]
run = "echo 'ðŸŽ‰ GCP Bootstrap Completed!'"

[tasks."bootstrap-gcp:config"]
description = "Load GCP Configuration"
quiet = true
run = '''
# Load .env if exists
if [ -f ".env" ]; then
    export $(grep -v '^#' .env | xargs)
elif [ -f "../.env" ]; then
    export $(grep -v '^#' ../.env | xargs)
fi
# Export for subsequent tasks if run in same shell, though mise runs in subshells mostly.
# We might need to duplicate config loading or use a separate script if vars are needed across tasks.
# For now, we assume tasks are self-contained or load config themselves.
# Actually, mise doesn't persist env vars across tasks unless defined in [env] or exported in a parent task running them.
# So we will repeat the config loading block or assume [env] handles static ones.
# Dynamic ones like PROJECT_ID specific to user might need .env loading in each task.
'''

[tasks."bootstrap-gcp:api"]
description = "Enable required GCP APIs"
run = '''
# Load Config
if [ -f ".env" ]; then export $(grep -v '^#' .env | xargs); fi
PROJECT_ID="${PROJECT_ID:-outputudy}"

echo "ðŸ“¦ [Bootstrap] Ensuring APIs are enabled for ${PROJECT_ID}..."
gcloud services enable iam.googleapis.com \
    cloudresourcemanager.googleapis.com \
    iamcredentials.googleapis.com \
    sts.googleapis.com \
    sqladmin.googleapis.com \
    run.googleapis.com \
    cloudscheduler.googleapis.com --project "${PROJECT_ID}" > /dev/null 2>&1
echo "   âœ… APIs enabled."
'''

[tasks."bootstrap-gcp:iam"]
description = "Create CI Service Account & Roles"
run = '''
# Load Config
if [ -f ".env" ]; then export $(grep -v '^#' .env | xargs); fi
PROJECT_ID="${PROJECT_ID:-outputudy}"
SA_CI_NAME="github-actions-sa"
SA_CI_DISPLAY="Service Account for GitHub Actions"

echo "ðŸ‘¤ [Bootstrap] Managing CI Service Account..."
if ! gcloud iam service-accounts describe "${SA_CI_NAME}@${PROJECT_ID}.iam.gserviceaccount.com" --project "${PROJECT_ID}" > /dev/null 2>&1; then
    gcloud iam service-accounts create "${SA_CI_NAME}" --display-name="${SA_CI_DISPLAY}" --project "${PROJECT_ID}"
    echo "   âœ… Created SA: ${SA_CI_NAME}"
else
    echo "   âœ… SA exists: ${SA_CI_NAME}"
fi

SA_CI_EMAIL="${SA_CI_NAME}@${PROJECT_ID}.iam.gserviceaccount.com"

echo "ðŸ”‘ [Bootstrap] Ensuring Editor & IAM Admin roles..."
gcloud projects add-iam-policy-binding "${PROJECT_ID}" \
    --member="serviceAccount:${SA_CI_EMAIL}" \
    --role="roles/editor" > /dev/null
gcloud projects add-iam-policy-binding "${PROJECT_ID}" \
    --member="serviceAccount:${SA_CI_EMAIL}" \
    --role="roles/resourcemanager.projectIamAdmin" > /dev/null
echo "   âœ… Roles verified."
'''

[tasks."bootstrap-gcp:wif"]
description = "Configure Workload Identity Federation"
run = '''
# Load Config
if [ -f ".env" ]; then export $(grep -v '^#' .env | xargs); fi
PROJECT_ID="${PROJECT_ID:-outputudy}"
GITHUB_REPO="${GITHUB_REPO:-umwinter/outputudy}"
POOL_NAME="github-actions-pool"
PROVIDER_NAME="github-provider"
SA_CI_NAME="github-actions-sa"

echo "ðŸŠ [Bootstrap] Managing Workload Identity..."
if ! gcloud iam workload-identity-pools describe "${POOL_NAME}" --location="global" --project "${PROJECT_ID}" > /dev/null 2>&1; then
    gcloud iam workload-identity-pools create "${POOL_NAME}" --location="global" --display-name="GitHub Actions Pool" --project "${PROJECT_ID}"
    echo "   âœ… Pool created."
else
    echo "   âœ… Pool exists."
fi

if ! gcloud iam workload-identity-pools providers describe "${PROVIDER_NAME}" --workload-identity-pool="${POOL_NAME}" --location="global" --project "${PROJECT_ID}" > /dev/null 2>&1; then
    gcloud iam workload-identity-pools providers create-oidc "${PROVIDER_NAME}" \
        --workload-identity-pool="${POOL_NAME}" --location="global" --display-name="GitHub Provider" \
        --issuer-uri="https://token.actions.githubusercontent.com" \
        --attribute-mapping="google.subject=assertion.sub,attribute.repository=assertion.repository" \
        --attribute-condition="assertion.repository == '${GITHUB_REPO}'" \
        --project "${PROJECT_ID}"
    echo "   âœ… Provider created."
else
    echo "   âœ… Provider exists."
fi

SA_CI_EMAIL="${SA_CI_NAME}@${PROJECT_ID}.iam.gserviceaccount.com"
WORKLOAD_IDENTITY_USER="principalSet://iam.googleapis.com/projects/$(gcloud projects describe ${PROJECT_ID} --format='value(projectNumber)')/locations/global/workloadIdentityPools/${POOL_NAME}/attribute.repository/${GITHUB_REPO}"

gcloud iam service-accounts add-iam-policy-binding "${SA_CI_EMAIL}" \
    --role="roles/iam.workloadIdentityUser" \
    --member="${WORKLOAD_IDENTITY_USER}" \
    --project "${PROJECT_ID}" > /dev/null
echo "   âœ… Bound SA to GitHub Repo."
'''

[tasks."bootstrap-gcp:bucket"]
description = "Create Terraform State Bucket"
run = '''
# Load Config
if [ -f ".env" ]; then export $(grep -v '^#' .env | xargs); fi
PROJECT_ID="${PROJECT_ID:-outputudy}"
REGION="${REGION:-asia-northeast1}"
TF_STATE_BUCKET="${PROJECT_ID}-tfstate"

echo "ðŸª£ [Bootstrap] Managing Terraform State Bucket..."
if ! gcloud storage buckets describe "gs://${TF_STATE_BUCKET}" --project "${PROJECT_ID}" > /dev/null 2>&1; then
    gcloud storage buckets create "gs://${TF_STATE_BUCKET}" --location="${REGION}" --project "${PROJECT_ID}"
    echo "   âœ… Bucket created: ${TF_STATE_BUCKET}"
else
    echo "   âœ… Bucket exists."
fi
'''

[tasks.lint]
description = "Run all linters (monorepo)"
run = "mise run //backend:lint //frontend:lint"

[tasks.format]
description = "Run all formatters (monorepo)"
run = "mise run //backend:format //frontend:format"

[tasks.test]
description = "Run all tests (monorepo)"
run = "mise run //backend:test //frontend:test"
