[tools]
python = "3.12"
node = "22.16.0"
pnpm = "10.27.0"
uv = "latest"

[tasks.up]
description = "Start all services (detached)"
run = "docker-compose up -d"

[tasks.down]
description = "Stop and remove containers"
run = "docker-compose down"

[tasks.build]
description = "Build/Rebuild services"
run = "docker-compose up -d --build"

[tasks.logs]
description = "Tail logs for all services"
run = "docker-compose logs -f"

[tasks.backend-shell]
description = "Enter backend container shell"
run = "docker-compose exec backend /bin/bash"

[tasks.test-backend]
description = "Run backend tests"
run = "docker-compose run --rm backend uv run pytest"

[tasks.test-frontend]
description = "Run frontend tests"
run = "docker-compose run --rm frontend pnpm test"

[tasks.test-e2e]
description = "Run E2E tests (Playwright)"
run = "docker-compose run --rm e2e"

[tasks.lint]
description = "Run linting (ruff, biome)"
depends = ["lint:backend", "lint:frontend"]

[tasks."lint:backend"]
run = "docker-compose run --rm backend sh -c 'uv run ruff check . && uv run basedpyright .'"

[tasks."lint:frontend"]
run = "docker-compose run --rm frontend pnpm exec biome check ."

[tasks.format]
description = "Run formatting (ruff, biome)"
depends = ["format:backend", "format:frontend"]

[tasks."format:backend"]
run = "docker-compose run --rm backend uv run ruff format ."

[tasks."format:frontend"]
run = "docker-compose run --rm frontend pnpm exec biome check --write ."

# --- Setup Tasks ---

[tasks."setup:env"]
description = "Create .env from .env.example if missing"
run = """
if [ ! -f .env ]; then
    cp .env.example .env
    echo "âœ… .env created."
else
    echo "âœ… .env already exists."
fi
"""

[tasks."setup:hooks"]
description = "Install Git Hooks (pre-commit)"
run = """
if command -v pre-commit >/dev/null 2>&1; then
    pre-commit install
    pre-commit install --hook-type pre-push
    echo "âœ… Git Hooks installed."
else
    echo "âš ï¸ pre-commit not found. Skipping."
fi
"""

[tasks."setup:db"]
description = "Initialize Database (Migrate & Seed)"
depends = ["up"]
run = """
echo "ğŸ—„ï¸ Waiting for database..."
sleep 5
echo "OR Running migrations..."
docker-compose exec backend alembic upgrade head
echo "ğŸŒ± Seeding data..."
docker-compose exec backend sh -c "PYTHONPATH=. python scripts/seed.py"
"""

[tasks.setup]
description = "Full project setup (Local)"
depends = ["setup:env", "setup:hooks", "setup:db"]
run = """
echo "âœ¨ Setup complete! Access: http://localhost:3000"
"""

[tasks.setup-gcp]
description = "GCP/CI Environment Setup"
run = ".mise/tasks/setup-gcp"
